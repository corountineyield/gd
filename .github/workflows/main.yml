name: Build GDMacro

on:
  push:
    branches: [ main, master, dev ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build iOS Dylib
    runs-on: macos-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Download Fishhook
      run: |
        curl -o fishhook.c https://raw.githubusercontent.com/facebook/fishhook/main/fishhook.c
        curl -o fishhook.h https://raw.githubusercontent.com/facebook/fishhook/main/fishhook.h
        echo "âœ“ Downloaded fishhook"
        
    - name: Create Bridging Header
      run: |
        cat > GDMacro-Bridging-Header.h << 'EOF'
        #ifndef GDMacro_Bridging_Header_h
        #define GDMacro_Bridging_Header_h
        #import "fishhook.h"
        #endif
        EOF
        echo "âœ“ Created bridging header"
        
    - name: Compile Fishhook
      run: |
        mkdir -p build
        xcrun -sdk iphoneos clang \
          -c \
          -arch arm64 \
          -isysroot $(xcrun --sdk iphoneos --show-sdk-path) \
          -miphoneos-version-min=14.0 \
          -o build/fishhook.o \
          fishhook.c
        echo "âœ“ Compiled fishhook"
        
    - name: Compile GDMacro
      run: |
        xcrun -sdk iphoneos swiftc \
          -emit-library \
          -target arm64-apple-ios14.0 \
          -sdk $(xcrun --sdk iphoneos --show-sdk-path) \
          -O \
          -import-objc-header GDMacro-Bridging-Header.h \
          -Xlinker -rpath -Xlinker @executable_path \
          -o build/GDMacro.dylib \
          GDMacro.swift \
          build/fishhook.o
        echo "âœ“ Compiled GDMacro.dylib"
        
    - name: Code Sign (Ad-hoc)
      run: |
        codesign -f -s - build/GDMacro.dylib || echo "âš ï¸ Code signing skipped"
        
    - name: Get Build Info
      id: build_info
      run: |
        echo "size=$(ls -lh build/GDMacro.dylib | awk '{print $5}')" >> $GITHUB_OUTPUT
        echo "sha=$(shasum -a 256 build/GDMacro.dylib | awk '{print $1}')" >> $GITHUB_OUTPUT
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: GDMacro-iOS-arm64
        path: build/GDMacro.dylib
        retention-days: 30
        
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: build/GDMacro.dylib
        body: |
          ## GDMacro iOS Build
          
          **File:** GDMacro.dylib
          **Size:** ${{ steps.build_info.outputs.size }}
          **SHA256:** `${{ steps.build_info.outputs.sha }}`
          
          ### Installation
          1. Download `GDMacro.dylib`
          2. Copy to your iOS device
          3. Create directory: `Documents/Flero/flero/replays/`
          4. Add your `.gdr2` replay files
          5. Inject using insert_dylib, CydiaSubstrate, or TrollStore
          
          ### Features
          - âœ… GDR2 replay format support
          - âœ… Touch injection via Cocos2d-x hooks
          - âœ… Legit mode with user input tracking
          - âœ… Draggable UI overlay
          - âœ… Practice mode fix
          
          Built with GitHub Actions on macOS
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Build Summary
      run: |
        echo "## Build Complete! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**File:** GDMacro.dylib" >> $GITHUB_STEP_SUMMARY
        echo "**Size:** ${{ steps.build_info.outputs.size }}" >> $GITHUB_STEP_SUMMARY
        echo "**SHA256:** \`${{ steps.build_info.outputs.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Download" >> $GITHUB_STEP_SUMMARY
        echo "Go to the **Actions** tab and download the artifact from this run." >> $GITHUB_STEP_SUMMARY
